@page "/detailedview/{Id:int}"

@using ElevPortalen.Pages.AlertBox
@using ElevPortalen.Data;
@using ElevPortalen.Services;
@using ElevPortalen.Models;
@using System.Security.Claims

@inject StudentService _studentService
@inject CompanyService _companyService
@inject SkillService _skillService
@inject AuthenticationStateProvider AuthenticationStateProvider

<div class="container p-4">

    <AuthorizeView Roles="Company,Student,Admin">

        <Authorized>

            @isStudent;
            @isCompany;
            @if (isCompany && _student.Any())
            {
                @foreach (var data in _student)
                {
                    <!--User profile container-->
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card mb-4 shadow-sm">
                                <div class="card-body text-center">
                                    @if (data.profileImage != "")
                                    {
                                        <img src="images/ProfileImages/@data.profileImage" alt="avatar"
                                             class="rounded-circle img-fluid" style="width: 150px; height:150px;">
                                    }
                                    else
                                    {
                                        <img src="images/DefaultAvatar.jpg" alt="avatar"
                                             class="rounded-circle img-fluid" style="width: 150px;">
                                    }
                                    <h5 class="my-3">
                                        @data.FirstName
                                        @data.LastName
                                    </h5>
                                    <p class="text-muted mb-4">Specialiseret i @data.Speciality</p>
                                    <div class="d-flex justify-content-center mb-2">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-8">
                            <div class="card mb-4">
                                <div class="card-body shadow-sm">
                                    <div class="row">
                                        <div class="col-sm-3">
                                            <p class="mb-0">Title</p>
                                        </div>
                                        <div class="col-sm-9">
                                            <p class="text-muted mb-0">@data.Title</p>
                                        </div>
                                    </div>
                                    <hr />
                                    <div class="row">

                                        <div class="col-sm-3">
                                            <p class="mb-0">Fulde navn</p>
                                        </div>
                                        <div class="col-sm-9">
                                            <p class="text-muted mb-0">
                                                @data.FirstName <span> </span>
                                                @if (!string.IsNullOrEmpty(data.MiddleName))
                                                {
                                                    @data.MiddleName <span> </span>
                                                }
                                                @data.LastName
                                            </p>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-sm-3">
                                            <p class="mb-0">Mobile</p>
                                        </div>
                                        <div class="col-sm-9">
                                            <p class="text-muted mb-0">@data.PhoneNumber</p>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row">
                                        <div class="col-sm-3">
                                            <p class="mb-0">Adresse</p>
                                        </div>
                                        <div class="col-sm-9">
                                            <p class="text-muted mb-0">@data.Address</p>
                                        </div>
                                    </div>
                                    <hr />
                                    <div class="row">
                                        <div class="col-sm-3">
                                            <p class="mb-0">Beskrivelse</p>
                                        </div>
                                        <div class="col-sm-9">
                                            <p class="text-muted mb-0">@data.Description</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Skills section -->
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card mb-4">
                                <div class="card-body shadow-sm">
                                    <h5 class="fw-bold">Øvet i</h5>
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <!--Show skill names section-->
                                            @if (data != null && data.Skills != null)
                                            {
                                                <div class="col-lg-12">
                                                    <!--display the names of the skills in a single row-->
                                                    <h5>
                                                        @foreach (var skillName in _SkillsOfStudent)
                                                        {
                                                            <span class="badge bg-dark m-1">@skillName</span>
                                                        }
                                                    </h5>
                                                </div>
                                            }
                                            else
                                            {

                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card mb-4">
                                <div class="card-body shadow-sm">
                                    <h5 class="fw-bold">Social</h5>
                                    <div class="row">
                                        <div class="col-lg-12">
                                            <div class="d-flex align-items-center">
                                                <a href="#" class="mx-2" style="color: black">
                                                    <span class="fa-stack fa-sm">
                                                        <i class="fas fa-circle fa-stack-2x"></i>
                                                        <i class="fab fa-facebook fa-stack-1x fa-inverse"></i>
                                                    </span>
                                                </a>
                                                <a href="#" class="mx-2" style="color: black">
                                                    <span class="fa-stack fa-sm">
                                                        <i class="fas fa-circle fa-stack-2x"></i>
                                                        <i class="fab fa-instagram fa-stack-1x fa-inverse"></i>
                                                    </span>
                                                </a>
                                                <a href="#" class="mx-2" style="color: black">
                                                    <span class="fa-stack fa-sm">
                                                        <i class="fas fa-circle fa-stack-2x"></i>
                                                        <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                                                    </span>
                                                </a>
                                                <a href="#" class="mx-2" style="color: black">
                                                    <span class="fa-stack fa-sm">
                                                        <i class="fas fa-circle fa-stack-2x"></i>
                                                        <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                                                    </span>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                }
            }
            else if (isStudent && _company.Any())
            {
                <p>the company deatiled view will be here...</p>
            }
            else if (isStudent && !_company.Any())
            {
                _alertBox.SetMessage(true, "No company data found!", 0, warning: true);
            }
            else if(isCompany && !_student.Any())
            {
                _alertBox.SetMessage(true, "No student data found!", 0, warning: true);
            }
            else if (!isStudent && !isCompany)
            {
                _alertBox.SetMessage(true, "No Role assugned to user!", 0, warning: true);
            }

        </Authorized>

        <NotAuthorized>
            <AlertBox IsVisible=true Message="You need to log in first." isDanger=true waitForSeconds="0"></AlertBox>
        </NotAuthorized>

    </AuthorizeView>


</div>
<AlertBox @ref="_alertBox" />

@code {
    [Parameter]
    public int Id { get; set; }
    private AuthenticationState? _authState;
    private ClaimsPrincipal? _user;

    private List<StudentModel> _student = new List<StudentModel>();
    private List<CompanyModel> _company = new List<CompanyModel>();
    private List<string> _SkillsOfStudent = new List<string>();
    private SkillModel _Skills = new SkillModel();
    private AlertBox _alertBox = new AlertBox();

    private string Company = "Company";
    private string Student = "Student";
    private string _Name = "Default";
    private string Message = "";

    private bool isStudent = false;
    private bool isCompany = false;

    #region Oninitialize
    protected override async Task OnInitializedAsync()
    {
        await AuthenticateAndGetData();
    }
    #endregion

    #region Authentivate user and read data according to Role
    private async Task AuthenticateAndGetData()
    {
        // Getting the user current authentication state.
        _authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();

        if (_authState != null)
        {
            if (_authState.User.Identity?.IsAuthenticated == true && _authState != null && _authState.User != null)
            {
                _user = _authState.User;
                _Name = _user.Identity.Name!.ToString();

                if (_authState.User.IsInRole(Company))
                {
                    await GetStudentProfile(Id);
                }
                else if (_authState.User.IsInRole(Student))
                {
                    await GetCompanyProfile(Id);
                }
                else
                {
                    _alertBox.SetMessage(true, "Authentication failed!", 0, danger: true);
                }
            }
        }
    }
    #endregion

    #region Getting the data with the service call from student
    public async Task GetStudentProfile(int id)
    {
        isCompany = true;
        isStudent = false;

        _student = await _studentService.GetStudentByIdToList(id);
        await GetSkills(_student);
    }
    #endregion

    #region Getting the data with the service call from student
    public async Task GetCompanyProfile(int id)
    {
        isCompany = false;
        isStudent = true;

        _company = await _companyService.GetCompanyByIdToList(id);
    }
    #endregion

    #region Getting the skill Name to List (string)
    private async Task GetSkills(List<StudentModel> data)
    {
        foreach (var studentData in _student)
        {
            _SkillsOfStudent = await _skillService.GetSkills(studentData);
        }
    }
    #endregion

}