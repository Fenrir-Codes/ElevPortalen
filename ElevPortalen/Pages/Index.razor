@page "/"
@*Lavet af Jozsef*@

@using ElevPortalen.Services;
@using ElevPortalen.Data;
@using ElevPortalen.Models;

@inject ElevPortalenDataDbContext _context
@inject StudentService _studentService
@inject CompanyService _companyService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IConfiguration Configuration
@inject NavigationManager NavManager

<PageTitle>Home</PageTitle>

@* HHTMl and its logic*@
<div class="container-fluid">
    <div class="bg-image-container text-center" style="height: 100vh; position: relative;">
        <div class="bg-image" style="background-image: url('/images/Logo_ElevPortalen.png'); background-size: cover; background-position: center; position: absolute; top: 0; right: 0; bottom: 0; left: 0; opacity: 0.1;"></div>

        <!-- Text Over Image -->
        <div class="text-container mb-4" style="position: relative; top: 4%; color: black; z-index: 1;">
            <h1>Velkommen til ElevPortalen</h1>
        </div>

        @if (isAuthenticated)
        {

            @if (_authState.User.IsInRole(Student) && _companyList.Count >= 1)
            {
                <!-- Display Company-related content -->
                <div class="container mt-5">
                    @foreach (var data in _companyList)
                    {
                        <div class="card">
                            <div class="card-header">
                                @data.CompanyName
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">Special title treatment</h5>
                                <p class="card-text">@data.Description</p>
                                <a href="#" class="btn btn-primary">Go somewhere</a>
                            </div>
                        </div>
                    }
                </div>
            }
            else if (_authState.User.IsInRole(Company) && _studentList.Count >= 1)
            {
                <!-- Display Student-related content -->
                <div class="container mt-5">
                    @foreach (var data in _studentList)
                    {
                        <div class="card">
                            <div class="card-header">
                                @data.LastName
                            </div>
                            <div class="card-body">
                                <h5 class="card-title">@data.Title</h5>
                                <p class="card-text">@data.Description</p>
                                <a href="#" class="btn btn-primary">Go somewhere</a>
                            </div>
                        </div>
                    }
                </div>
            }
            

        }
        else
        {
            <div class="d-inline-flex align-items-center">
                @* Message = " eller "; *@
                <a href="/Identity/Account/Login" class="btn mb-3 btn-hover-change" role="button" data-bs-toggle="button">Login</a>
                @* <p>@Message</p> *@
                <p> eller </p>
                <a href="/Identity/Account/Register" class="btn mb-3 btn-hover-change" role="button" data-bs-toggle="button">Registrer</a>
                <p> dig først</p>
            </div>
        }
        

        <div style="position: absolute; bottom: 0; width: 100%; text-align: center;">
            <p style="padding-bottom: 40px; margin-bottom: 0;">Udforsk Danmarks Mest Eftertragtede Sted for Lærepladser – Dit Springbræt til Succes og Innovation!</p>
        </div>
    </div>
</div>

@code {
    // private fields within the scope of the class
    private AuthenticationState? _authState;
    private List<StudentModel> _studentList = new List<StudentModel>();
    private List<CompanyModel> _companyList = new List<CompanyModel>();

    private bool isAuthenticated = false;
    private string Company = "Company";
    private string Student = "Student";
    private string Message = "";

    #region OnInitialize
    protected override async Task OnInitializedAsync()
    {
        // Getting the user current authentication state.
        _authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();

        if (_authState != null)
        {
            if (_authState.User.Identity?.IsAuthenticated == true)
            {
                // If authenticated set the bool to true zhan read the users data from the data table with the help of ReadData function
                isAuthenticated = true;

                await ReadAllData();
            }
            else
            {
                isAuthenticated = false;
            }
        }
    }
    #endregion

    #region Reading the data from the database with the user claims
    public async Task ReadAllData()
    {
        if (_authState.User.IsInRole(Student)) // If the role is Student
        {
            //Getting the data
            _companyList = await _companyService.ReadAllCompanyData();
        }
        else if (_authState.User.IsInRole(Company)) // If the role is Company
        {
            //Getting the data with the service call from company
            _studentList = await _studentService.ReadAllStudentData();
        }
        else
        {
            Message = $"Could not read data.";
        }
    }
    #endregion

    #region Navigate to profile function
    private void GoToProfile()
    {
        NavManager.NavigateTo("/profile");
    }
    #endregion

}
